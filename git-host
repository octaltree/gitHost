#!/usr/bin/python3
# written in Python 3.4.3

from enum import Enum
import sys
#import traceback
import argparse
import urllib.parse
import urllib.request
import urllib.error
import json
import re
#import logging

# undefined :: a
undefined = None

# USERAGENT :: Str
USERAGENT = 'gitHost/0.0.1.0' # 何かしら指定しないとhubに怒られる

class OAuthConsumer:
    # :: OAuthConsumer -> Str -> Str ->  OAuthConsumer
    def __init__(self, consumerkey, consumersecret):
        self.key = consumerkey
        self.secret = consumersecret
    __str__ = lambda self: '{{"key": "{0}", "secret": "{1}"}} :: OAuthConsumer'.format(self.key, self.secret)
    key = None# :: Str
    secret = None# :: Str

# main :: IO Int
def main():
    rootp = argparse.ArgumentParser(description='manage git remote host')
    subp = rootp.add_subparsers(description='')
    repop = subp.add_parser('repo', help='manipulate remote repo')
    addp = subp.add_parser('add', help='add hosting service provider & user')
    args = rootp.parse_args()
    #print(args)

    #response = getOwnBucketRepos("octaltree", "L77RXViFwqKQnQLJNNSoPxFVA4QGdsHhlI4FWprfQFJFYOSyq-3YjK1HW1NBCUq88Ip2Bn0Ygaz3I_90Ig==")
    #repos = json.loads(body(response))['values'] # :: Dict
    #[print(urlFullNameBucketRepo(repo)) for repo in repos]
    print(OAuthConsumer('a', 'b'))
    return undefined

# :: Dict -> Str
urlFullNameBucketRepo = lambda repo: "{0}/{1}".format(repo['owner']['username'], repo['name'])

# :: Dict -> Str
urlFullNameHubRepo = lambda repo: repo['full_name']

# :: Dict -> Str
urlFullNameLabRepo = lambda repo: repo['path_with_namespace']

# :: urllib.request.Request -> IO urllib.request.HTTPResponse
def http(request):
    request.add_header("User-Agent", USERAGENT)
    try:
        return urllib.request.urlopen(request)
    except urllib.error.HTTPError as e:
        #exctype, excval, exctraceback = sys.exc_info()
        print("*** Request", file=sys.stderr)
        print(" ", request.get_method(), request.full_url, file=sys.stderr)
        #print(" ", request.header_items(), file=sys.stderr)
        [print(" ", tpl, file=sys.stderr) for tpl in request.header_items()]
        print(" ", request.data, file=sys.stderr)
        print("", file=sys.stderr)
        print("*** Response", file=sys.stderr)
        print(" ", e.status, e.reason, file=sys.stderr)
        #print(" ", e.getheaders(), file=sys.stderr)
        [print(" ", tpl, file=sys.stderr) for tpl in e.getheaders()]
        print(" ", e.read(), file=sys.stderr)
        exit(1)

# :: Str -> Str -> IO urllib.request.HTTPResponse
def getOwnBucketRepos(user, token):
    url = "https://api.bitbucket.org/2.0/repositories/{0}".format(urllib.parse.quote(user))
    headers = { "Authorization": "Bearer {0}".format(token)}
    return http(urllib.request.Request(url, headers=headers))

# :: Str -> Str -> IO urllib.request.HTTPResponse
def getOwnHubRepos(user, token):
    url = "https://api.github.com/user/repos"
    headers = { "Authorization": "token {0}".format(token)}
    return http(urllib.request.Request(url, headers=headers))

# :: Str -> Str -> IO urllib.request.HTTPResponse
def getOwnLabRepos(user, token):
    url = "https://gitlab.com/api/v3/projects"
    headers = { "PRIVATE-TOKEN": "{0}".format(token)}
    return http(urllib.request.Request(url, headers=headers))

# :: urllib.request.HTTPResponse -> Str
def body(response):
    contenttype = response.getheader('Content-Type', default='charset=utf-8')
    charset = charsetFromContentType(contenttype)
    if charset is None :
        charset = 'utf-8'
    return response.read().decode(charset)

# :: Str -> Str
def charsetFromContentType(str):
    lines = str.split(';')
    charsets = list(filter(lambda s: 'charset' in s, lines))
    if len(charsets) == 0 :
        return None
    charset = charsets.pop().replace(' ', '')
    mat = re.match('^charset=(.*)[;]*$', charset)
    return mat.group(1) if mat else None

def newOwnBucketRepo():
    return undefined

def newOwnHubRepo():
    return undefined

def newOwnLabRepo():
    return undefined


if __name__ == "__main__" :
  exit(main())

# vim:fenc=utf-8 ff=unix ft=python ts=4 sw=4 sts=4 si et fdm=indent fdl=0 fdn=1:
# vim:cinw=if,elif,else,for,while,try,except,finally,def,class:
